<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clinic Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #chatWindow { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
        .message { margin: 5px 0; }
        .sent { text-align: right; color: blue; }
        .received { text-align: left; color: green; }
    </style>
</head>
<body>
    <h2>Clinic Chat</h2>

    <div>
        <label>Session ID:</label>
        <input type="text" id="sessionId" />
        <label>User ID:</label>
        <input type="text" id="userId" />
        <button onclick="joinSession()">Join Session</button>
    </div>

    <p id="connectionStatus"></p>

    <div id="chatWindow"></div>

    <input type="text" id="messageInput" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>

    <script>
        let connection = null;
        let currentSessionId = null;
        let currentUserId = null;

        async function joinSession() {
            currentSessionId = document.getElementById('sessionId').value.trim();
            currentUserId = document.getElementById('userId').value.trim();

            if (!currentSessionId || !currentUserId) {
                alert('Please enter both Session ID and User ID');
                return;
            }

            if (!connection) {
                await startConnection();
            }

            try {
                await connection.invoke("JoinChatSession", currentSessionId);
                console.log("Joined session:", currentSessionId);

                document.getElementById('chatWindow').innerHTML = '';
                document.getElementById('connectionStatus').textContent = `Connected to session ${currentSessionId}`;

                await loadMessageHistory();
            } catch (err) {
                console.error("Error joining session:", err);
                alert('Failed to join session');
            }
        }

        async function startConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on("ReceiveMessage", (message) => {
                console.log("Received real-time message:", message);
                const isMine = message.senderId === currentUserId;
                addMessage(message, isMine);
            });

            try {
                await connection.start();
                console.log("SignalR connected.");
            } catch (err) {
                console.error("SignalR connection failed:", err);
            }
        }

        async function loadMessageHistory() {
            try {
                const res = await fetch(`/api/Chat/GetChatHistory/${currentSessionId}`);
                const messages = await res.json();
                messages.forEach(msg => {
                    const isMine = msg.senderId === currentUserId;
                    addMessage(msg, isMine);
                });
                console.log("Loaded chat history.");
            } catch (err) {
                console.error("Error loading history:", err);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;

            const message = {
                sessionId: currentSessionId,
                senderId: currentUserId,
                message: text,
                timestamp: new Date().toISOString()
            };

            try {
                // Send via SignalR only (hub will broadcast it to both users)
                await connection.invoke("SendMessage", message);

                // Save to database manually
                await fetch('/api/Chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(message)
                });

                input.value = '';
            } catch (err) {
                console.error("Error sending message:", err);
            }
        }

        function addMessage(message, isMine) {
            const div = document.createElement('div');
            div.className = 'message ' + (isMine ? 'sent' : 'received');
            const time = new Date(message.timestamp).toLocaleTimeString();
            div.innerHTML = `<strong>${isMine ? 'You' : message.senderId}</strong> [${time}]: ${message.message}`;
            document.getElementById('chatWindow').appendChild(div);
            document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
        }
    </script>
</body>
</html>
